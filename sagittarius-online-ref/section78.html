<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-eqiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="../lib/style.css">
    <title>Sagittarius Users' Reference</title>
  </head>
  <div class="prev-next">
    <a class="prev" href="section77.html">(util bytevector) - Bytevector utility library</a>
    <a class="top" href="../sagittarius-online-ref.html">Top</a>
    <a class="next" href="section79.html">(crypto) - Cryptographic library</a>
  </div>
  <section class="subsection"><h3 class="subsection">
    <a class="section.anchor" name="concurrent"><span class="section-number">7.8</span>(util concurrent) - Concurrency utilities</a>
  </h3>
<p /><div class="define">
    <span class="define-category">Library</span>
    <a name="(util concurrent)1736">
      <span class="name" name="(util concurrent)">(util concurrent)</span>
    </a>
  </div>
<div class="desc">This library provides high level concurrency APIs.</div>
<p />Using low level thread and mutex sometimes causes dead lock or incomprehensible
code. This library provides frameworks of common use cases. This library is
built on top of SRFI-18.
<p /><section class="subsubsection"><h4 class="subsubsection">
    <a class="section.anchor" name="G1737"><span class="section-number">7.8.1</span>Future</a>
  </h4>
<p /><div class="define">
    <span class="define-category">Library</span>
    <a name="(util concurrent future)1738">
      <span class="name" name="(util concurrent future)">(util concurrent future)</span>
    </a>
  </div>
<div class="desc">A sub library of <code>(util concurrent)</code>. This library provides
future related APIs.</div>
<p />A future is an object that has a task which is a thunk and will be executed
in future. In this implementation, future is an interface and its execution
is depending on the sub class. The default implementation this library
provides uses a thread per future. If users don't have to manage number
of threads, then using this is sufficient.
<p /><div class="codeblock-box">
    <pre class="codeblock">(import (rnrs) (util concurrent))

;; creates 5 futures
(define futures
  (map (lambda (i) (future (* i i))) '(1 2 3 4 5)))

;; wait and retrieve the results
(map future-get futures)
</pre>
    <span class="codeblock-arrow">=&gt;</span>
    <span class="codeblock-result">(1 4 9 16 25)</span>
  </div>
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<future&gt;1739">
      <span class="name" name="<future&gt;">&lt;future&gt;</span>
    </a>
  </div>
<div class="desc">The interface of all futures.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future?1740">
    <span class="name" name="future?">future?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is a future object, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Macro</span><a name="future1741">
    <span class="name" name="future">future</span>
  </a> <span class="args">expr ...</span></div>
<div class="define"><span class="define-category">Macro</span><a name="future1742">
    <span class="name" name="future">future</span>
  </a> <span class="args">(class record)expr ...</span></div>
<div class="desc">Creates a future which executes <var>expr</var>. The type of the
returning future is <var>record</var>.
<p />The first form is equivalent with the following:
<code>(future (class &lt;simple-future&gt;) <var>expr ...</var>)</code>
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future-get1743">
    <span class="name" name="future-get">future-get</span>
  </a> <span class="args">future</span></div>
<div class="desc">Retrieves the result of the given <var>future</var>.
<p />This procedure waits if the execution of the <var>future</var> isn't finished yet.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future-cancel1744">
    <span class="name" name="future-cancel">future-cancel</span>
  </a> <span class="args">future</span></div>
<div class="desc">Cancels the execution of <var>future</var>.
<p />This procedure may or may not cancel the execution depending on the
implementation of <var>future</var>. The <code>&lt;simple-future&gt;</code> provides by
this library won't disturb the execution. Thus calling this procedure
doesn't do anything but changing the future's state.
<p />NOTE: once this procedure is called, then calling <code>future-get</code>
with <var>future</var> raises a <code>&amp;future-terminated</code>.
<p /><div class="codeblock-box">
    <pre class="codeblock">(import (rnrs) (util concurrent))

(define f (future (display "cancelled") (newline)))
(future-cancel f)
(future-get f)
</pre>
    <span class="codeblock-arrow">=&gt;</span>
    <span class="codeblock-result">&amp;future-terminated</span>
  </div>
<p />The above example may or may not print <code>"cancelled"</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future-done?1745">
    <span class="name" name="future-done?">future-done?</span>
  </a> <span class="args">future</span></div>
<div class="desc">Returns #t if given execution of <var>future</var> is finished, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future-cancelled?1746">
    <span class="name" name="future-cancelled?">future-cancelled?</span>
  </a> <span class="args">future</span></div>
<div class="desc">Returns #t if given execution of <var>future</var> is terminated by
<code>future-cancel</code>, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future-state1747">
    <span class="name" name="future-state">future-state</span>
  </a> <span class="args">future</span></div>
<div class="desc">Returns current state of the given <var>future</var>.
<p />The returning state is depending on the implementation of <var>future</var>.
Only 2 states are defined in this library, <code>done</code> and <code>terminated</code>.
<p /><code>done</code> is set when <code>future-get</code> is called.
<p /><code>terminated</code> is set when <code>future-cancel</code> is called.
</div>
<p /><div class="define">
    <span class="define-category">Condition Type</span>
    <a name="&amp;future-terminated1748">
      <span class="name" name="&amp;future-terminated">&amp;future-terminated</span>
    </a>
  </div>
<div class="desc">This type describes when a future is terminated but users try to
retrieve its result.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="future-terminated?1749">
    <span class="name" name="future-terminated?">future-terminated?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is object of <code>&amp;future-terminated</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="terminated-future1750">
    <span class="name" name="terminated-future">terminated-future</span>
  </a> <span class="args">condition</span></div>
<div class="desc"><var>condition</var> must be a <code>&amp;future-terminated</code> condition.
<p />Retrieve terminated future from <var>condition</var>.
</div>
<p /><section class="sub-section"><h5 class="sub-section">
    <a class="section.anchor" name="G1751"><span class="section-number">7.8.1.1</span>Simple future</a>
  </h5>
<p />Simple future is a future implementation which executes the task
on a thread immediately.
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<simple-future&gt;1752">
      <span class="name" name="<simple-future&gt;">&lt;simple-future&gt;</span>
    </a>
  </div>
<div class="desc">Default <code>&lt;future&gt;</code> implementation of this library.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="simple-future?1753">
    <span class="name" name="simple-future?">simple-future?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is a simple future, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="make-simple-future1754">
    <span class="name" name="make-simple-future">make-simple-future</span>
  </a> <span class="args">thunk</span></div>
<div class="desc">Creates a simple future which executes <var>thunk</var>.</div>
<p />
</section></section><section class="subsubsection"><h4 class="subsubsection">
    <a class="section.anchor" name="G1755"><span class="section-number">7.8.2</span>Executor</a>
  </h4>
<p /><div class="define">
    <span class="define-category">Library</span>
    <a name="(util concurrent executor)1756">
      <span class="name" name="(util concurrent executor)">(util concurrent executor)</span>
    </a>
  </div>
<div class="desc">A sub library of <code>(util concurrent)</code>. This library provides
executor related APIs.</div>
<p />A executor is an object that executes submitted futures. The idea is taken
from <code>java.util.concurrent</code> package. The library provides 2 types
of executors, thread pool executor and fork join executor. The first
one uses thread pool, described below section, and the latter one
just creates a thread per task. The following is an example how to use
the executors:
<p /><div class="codeblock-box">
    <pre class="codeblock">(import (rnrs) (util concurrent))

;; creates executor which uses 5 threads and push all tasks
(define executor 
  (make-thread-pool-executor 5 push-future-handler))

;; creates 10 futures
(define futures 
  (map (lambda (i) 
         (future (class &lt;executor-future&gt;)
           (* i i)))
       '(1 2 3 4 5 6 7 8 9 10)))

;; execute futures
(for-each (lambda (future) (execute-future! executor future)) futures)

;; wait/retrieve the results
(map future-get futures)
</pre>
    <span class="codeblock-arrow">=&gt;</span>
    <span class="codeblock-result">(1 4 9 16 25 36 49 64 81 100)</span>
  </div>
<p />The thread pool executor with <code>push-future-handler</code> waits until the
previous taskes are finished. 
<p /><section class="sub-section"><h5 class="sub-section">
    <a class="section.anchor" name="G1757"><span class="section-number">7.8.2.1</span>Generic Executor APIs</a>
  </h5>
<p />Executor provided by this library is an extensible. So the most commonly
used procedures are generic.
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<executor&gt;1758">
      <span class="name" name="<executor&gt;">&lt;executor&gt;</span>
    </a>
  </div>
<div class="desc">The interface of executor.
<p />This record only has one field, <code>state</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="executor?1759">
    <span class="name" name="executor?">executor?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is an executor, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="executor-state1760">
    <span class="name" name="executor-state">executor-state</span>
  </a> <span class="args">executor</span></div>
<div class="desc">Returns <code>state</code> field of the <var>executor</var>.</div>
<p />
The behaviour of the folowing procedures depend on its implementation.
<p /><div class="define"><span class="define-category">Function</span><a name="executor-available?1761">
    <span class="name" name="executor-available?">executor-available?</span>
  </a> <span class="args">executor</span></div>
<div class="desc">Returns #t if the given <var>executor</var> is available, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="execute-future!1762">
    <span class="name" name="execute-future!">execute-future!</span>
  </a> <span class="args">executor future</span></div>
<div class="desc">Executes given <var>future</var> on <var>executor</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shutdown-executor!1763">
    <span class="name" name="shutdown-executor!">shutdown-executor!</span>
  </a> <span class="args">executor</span></div>
<div class="desc">Shutdowns the given <var>executor</var>. 
<p />This procedure may or may not affect the managed futures on the <var>executor</var>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="executor-submit!1764">
    <span class="name" name="executor-submit!">executor-submit!</span>
  </a> <span class="args">executor thunk</span></div>
<div class="desc">Converts <var>thunk</var> to a future and execute it on given <var>executor</var>,
then returns the future. This procedure is defined as follows:
<p /><pre class="codeblock">(define (executor-submit! e thunk)
  (let ((f (make-executor-future thunk)))
    (execute-future! e f)
    f))
</pre>
</div>
<p /></section><section class="sub-section"><h5 class="sub-section">
    <a class="section.anchor" name="G1765"><span class="section-number">7.8.2.2</span>Thread pool executor</a>
  </h5>
<p />Thread pool executor uses <code>(util concurrent thread-pool)</code> as its
underlying thread managing. So once the threads are created then the
thread holds its environment until the executor is shutdown. In other
words, if a task changes the dynamic environment, then the next task
uses the changed dynamic environment. The following example describes
how dynamic environments works on this executor:
<p /><div class="codeblock-box">
    <pre class="codeblock">(import (rnrs) (util concurrent) (srfi :39))

(define *one* (make-parameter 1))

(define executor (make-thread-pool-executor 1))

(let ((f1 (make-executor-future (lambda () (*one* 2) 1)))
      (f2 (make-executor-future (lambda () (*one*)))))
  (execute-future! executor f1)
  (future-get f1)
  (execute-future! executor f2)
  (future-get f2))
</pre>
    <span class="codeblock-arrow">=&gt;</span>
    <span class="codeblock-result">2</span>
  </div>
<p />NOTE: parameter objects are thread safe in general, thus if a thread is
created per future, then the parameter <code>*one*</code> is initialised with
the initial value <code>1</code> during thread creation.
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<thread-pool-executor&gt;1766">
      <span class="name" name="<thread-pool-executor&gt;">&lt;thread-pool-executor&gt;</span>
    </a>
  </div>
<div class="desc">Record type of thread pool executor. This record type inherits
<code>&lt;executor&gt;</code>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-executor?1767">
    <span class="name" name="thread-pool-executor?">thread-pool-executor?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is a thread pool executor, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="make-thread-pool-executor1768">
    <span class="name" name="make-thread-pool-executor">make-thread-pool-executor</span>
  </a>
 <span class="args">max-thread :optional reject-handler</span></div>
<div class="desc">Creates a thread pool executor with thread count <var>max-thread</var>.
<p />If optional argument <var>reject-handler</var> is specified, then the specified
handler is used. Otherwise, <code>abort-rejected-handler</code> is used.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-executor-pool-size1769">
    <span class="name" name="thread-pool-executor-pool-size">thread-pool-executor-pool-size</span>
  </a>
 <span class="args">thread-pool-executor</span></div>
<div class="desc">Returns number of futures currently executing on the given thread pool
executor.
<p />This number would be greater than the thread count if <code>push-future-handler</code>
is specified during the executor creation.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-executor-max-pool-size1770">
    <span class="name" name="thread-pool-executor-max-pool-size">thread-pool-executor-max-pool-size</span>
  </a>
 <span class="args">thread-pool-executor</span></div>
<div class="desc">Returns number of thread count of the given thread pool executor.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-executor-available?1771">
    <span class="name" name="thread-pool-executor-available?">thread-pool-executor-available?</span>
  </a>
 <span class="args">thread-pool-executor</span></div>
<div class="desc">Return #t if the number of executing future is less than the number of
thread count.
<p />NOTE: this procedure may return #f even tasks can be pushed to the executor
if <code>push-future-handler</code> is specified.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-executor-execute-future!1772">
    <span class="name" name="thread-pool-executor-execute-future!">thread-pool-executor-execute-future!</span>
  </a>
 <span class="args">thread-pool-executor future</span></div>
<div class="desc">Executes the given <var>future</var> on <var>thread-pool-executor</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-executor-shutdown!1773">
    <span class="name" name="thread-pool-executor-shutdown!">thread-pool-executor-shutdown!</span>
  </a>
 <span class="args">thread-pool-executor</span></div>
<div class="desc">Shutdown the given <var>thread-pool-executor</var>.</div>
<p />Builtin reject handlers.
<p />Reject handler is a procedure called when thread pool executor is not
available to decide how the executor should treat the given future.
<p /><div class="define">
    <span class="define-category">Function</span>
    <a name="abort-rejected-handler1774">
      <span class="name" name="abort-rejected-handler">abort-rejected-handler</span>
    </a>
  </div>
<div class="desc">Reject the future and raises <code>&amp;rejected-execution-error</code>.
<p />This is the default handler.
</div>
<p /><div class="define">
    <span class="define-category">Function</span>
    <a name="terminate-oldest-handler1775">
      <span class="name" name="terminate-oldest-handler">terminate-oldest-handler</span>
    </a>
  </div>
<div class="desc">Terminates the oldest future.
<p />When this handler is called, the thread which target future is running is
also terminated. Thus the dynamic environment is also reset.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="wait-finishing-handler1776">
    <span class="name" name="wait-finishing-handler">wait-finishing-handler</span>
  </a> <span class="args">wait-retry</span></div>
<div class="desc">Creats a reject handler which waits until one of the thread
is available.
<p />The <var>wait-retry</var> is a number of retry count. If none of future task
is finished by this counter, then <code>abort-rejected-handler</code> is called.
</div>
<p /><div class="define">
    <span class="define-category">Function</span>
    <a name="push-future-handler1777">
      <span class="name" name="push-future-handler">push-future-handler</span>
    </a>
  </div>
<div class="desc">Pushes the task to the least used thread.</div>
<p /><div class="define">
    <span class="define-category">Condition Type</span>
    <a name="&amp;rejected-execution-error1778">
      <span class="name" name="&amp;rejected-execution-error">&amp;rejected-execution-error</span>
    </a>
  </div>
<div class="desc">A condition describes when a future is rejected by an executor.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="rejected-execution-error?1779">
    <span class="name" name="rejected-execution-error?">rejected-execution-error?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is <code>&amp;rejected-execution-error</code> object.
Otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="rejected-future1780">
    <span class="name" name="rejected-future">rejected-future</span>
  </a> <span class="args">condition</span></div>
<div class="define"><span class="define-category">Function</span><a name="rejected-executor1781">
    <span class="name" name="rejected-executor">rejected-executor</span>
  </a> <span class="args">condition</span></div>
<div class="desc"><var>condition</var> must be a <code>&amp;rejected-execution-error</code> object.
<p />Retrieves the rejected future and executor, respectively.
</div>
<p /></section><section class="sub-section"><h5 class="sub-section">
    <a class="section.anchor" name="G1782"><span class="section-number">7.8.2.3</span>Fork join executor</a>
  </h5>
<p />Fork join executor is an executor which simply creats a thread per future.
It's almost the same as <code>&lt;simple-future&gt;</code>.
<p />
<div class="define">
    <span class="define-category">Record</span>
    <a name="<fork-join-executor&gt;1783">
      <span class="name" name="<fork-join-executor&gt;">&lt;fork-join-executor&gt;</span>
    </a>
  </div>
<div class="desc">Record type of fork join executor. This record type inherits
<code>&lt;executor&gt;</code>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="fork-join-executor?1784">
    <span class="name" name="fork-join-executor?">fork-join-executor?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is a fork join executor, otherwise #f.</div>
<p /><div class="define">
    <span class="define-category">Function</span>
    <a name="make-fork-join-executor1785">
      <span class="name" name="make-fork-join-executor">make-fork-join-executor</span>
    </a>
  </div>
<div class="desc">Creates a fork join executor. </div>
<p /><div class="define"><span class="define-category">Function</span><a name="fork-join-executor-available?1786">
    <span class="name" name="fork-join-executor-available?">fork-join-executor-available?</span>
  </a>
 <span class="args">fork-join-executor</span></div>
<div class="desc">Returns #t.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="fork-join-executor-execute-future!1787">
    <span class="name" name="fork-join-executor-execute-future!">fork-join-executor-execute-future!</span>
  </a>
 <span class="args">fork-join-executor future</span></div>
<div class="desc">Executes the given <var>future</var> on <var>fork-join-executor</var>.
<p />NOTE: the executor doesn't manage anything so the future is actually not
related to the executor.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="fork-join-executor-shutdown!1788">
    <span class="name" name="fork-join-executor-shutdown!">fork-join-executor-shutdown!</span>
  </a>
 <span class="args">fork-join-executor</span></div>
<div class="desc">Sets executor's state <code>shutdown</code>.</div>
<p /></section><section class="sub-section"><h5 class="sub-section">
    <a class="section.anchor" name="G1789"><span class="section-number">7.8.2.4</span>Executor future</a>
  </h5>
<p />An executor future is an future object which can be used on executor.
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<executor-future&gt;1790">
      <span class="name" name="<executor-future&gt;">&lt;executor-future&gt;</span>
    </a>
  </div>
<div class="desc">Record type of <code>&lt;executor-future&gt;</code>. This type inherits 
<code>&lt;future&gt;</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="executor-future?1791">
    <span class="name" name="executor-future?">executor-future?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if the given <var>obj</var> is an executor future, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="make-executor-future1792">
    <span class="name" name="make-executor-future">make-executor-future</span>
  </a> <span class="args">thunk</span></div>
<div class="desc">Creates an executor future object.</div>
<p />
</section></section><section class="subsubsection"><h4 class="subsubsection">
    <a class="section.anchor" name="G1793"><span class="section-number">7.8.3</span>Thread pool</a>
  </h4>
<p /><div class="define">
    <span class="define-category">Library</span>
    <a name="(util concurrent thread-pool)1794">
      <span class="name" name="(util concurrent thread-pool)">(util concurrent thread-pool)</span>
    </a>
  </div>
<div class="desc">A sub library of <code>(util concurrent)</code>. This library provides
thread pool APIs.</div>
<p />Creating a thread is not cheap on Sagittarius. If users want to reuse threads,
then this library can be used.
<p /><pre class="codeblock">(import (rnrs) (util concurrent))

;; pooling 5 thread
(define thread-pool (make-thread-pool 5))

(for-each (lambda (i) (thread-pool-push-task! thread-pool (lambda () (* i i))))
	  '(1 2 3 4 5 6 7 8 9 10))

;; waits until all tasks are done
(thread-pool-wait-all! thread-pool)

;; release thread-pool
(thread-pool-release! thread-pool)
</pre>
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<thread-pool&gt;1795">
      <span class="name" name="<thread-pool&gt;">&lt;thread-pool&gt;</span>
    </a>
  </div>
<div class="desc">Record type of thread pool.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool?1796">
    <span class="name" name="thread-pool?">thread-pool?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is a thread-pool, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="make-thread-pool1797">
    <span class="name" name="make-thread-pool">make-thread-pool</span>
  </a>
 <span class="args">thread-count :optional error-handler</span></div>
<div class="desc">Creates a thread pool with <var>thread-count</var> of threads. 
<p />If the optional argument <var>error-handler</var> is given, it must be a
procedure which accept one argument, then the procedure is called
when the pushed task raised an error.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-size1798">
    <span class="name" name="thread-pool-size">thread-pool-size</span>
  </a> <span class="args">thread-pool</span></div>
<div class="desc">Returns number of threads on the given <var>thread-pool</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-push-task!1799">
    <span class="name" name="thread-pool-push-task!">thread-pool-push-task!</span>
  </a> <span class="args">thread-pool thunk</span></div>
<div class="desc">Push the given <var>thunk</var> to least used <var>thread-pool</var>'s thread.
And returns the id of the pushed thread. This id can be used to retrive
the actual thread calling <code>thread-pool-thread</code> procedure.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-wait-all!1800">
    <span class="name" name="thread-pool-wait-all!">thread-pool-wait-all!</span>
  </a> <span class="args">thread-pool</span></div>
<div class="desc">Waits all the tasks pushed into the given <var>thread-pool</var>.
<p />The return value of the tasks are discarded.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-release!1801">
    <span class="name" name="thread-pool-release!">thread-pool-release!</span>
  </a> <span class="args">thread-pool :optional how</span></div>
<div class="desc">Joins all the thread on the given <var>thread-pool</var>.
<p />If optional argument how is specified <code>terminate</code>, then the procedure
terminates the thread instead of joining.
<p />NOTE: terminating a thread is very dangerous operation, so don't use casually.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-thread1802">
    <span class="name" name="thread-pool-thread">thread-pool-thread</span>
  </a> <span class="args">thread-pool id</span></div>
<div class="desc">Retrieves the pooled thread associated with given <var>id</var> from
given <var>thread-pool</var>.
<p />It signals an error if the given <var>id</var> is not a thread id.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-thread-id1803">
    <span class="name" name="thread-pool-thread-id">thread-pool-thread-id</span>
  </a> <span class="args">thread-pool thread</span></div>
<div class="desc">Retrieves the pooled thread id associated with given <var>thread</var> from
given <var>thread-pool</var>. The procedure takes O(n) where n is number of threads
managed by the <var>thread-pool</var>. It might be better to use
<code>(thread-pool-current-thread-id)</code> procedure to retrieve thread id from
managed threads.
<p />It signals an error if the given <var>thread</var> is not a managed thread.
<p />NOTE: if the thread is terminated, then the procedure also signals an error.
</div>
<p /><div class="define">
    <span class="define-category">Function</span>
    <a name="(thread-pool-current-thread-id)1804">
      <span class="name" name="(thread-pool-current-thread-id)">(thread-pool-current-thread-id)</span>
    </a>
  </div>
<div class="desc">Retrieves thread id of current thread. If the current thread is not
a managed thread, then #f is returned.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-thread-terminate!1805">
    <span class="name" name="thread-pool-thread-terminate!">thread-pool-thread-terminate!</span>
  </a> <span class="args">thread-pool id</span></div>
<div class="desc">Terminates the pooled thread associated with given <var>id</var> and recreate
a new thread into <var>thread-pool</var>.
<p />NTOE: this is a dangerous operation. Don't use it casually.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="thread-pool-thread-task-running?1806">
    <span class="name" name="thread-pool-thread-task-running?">thread-pool-thread-task-running?</span>
  </a> <span class="args">thread-pool id</span></div>
<div class="desc">Returns #t if the given <var>id</var> of thread in the <var>thread-pool</var> is 
running. Otherwise #f.
</div>
<p /></section><section class="subsubsection"><h4 class="subsubsection">
    <a class="section.anchor" name="G1807"><span class="section-number">7.8.4</span>Shared queues</a>
  </h4>
<p /><div class="define">
    <span class="define-category">Library</span>
    <a name="(util concurrent shared-queue)1808">
      <span class="name" name="(util concurrent shared-queue)">(util concurrent shared-queue)</span>
    </a>
  </div>
<div class="desc">A sub library of <code>(util concurrent)</code>. This library provides
shared queue APIs.</div>
<p />A shared queue is a queue whose operations are done atomically.
<p /><div class="codeblock-box">
    <pre class="codeblock">(import (rnrs) (util concurrent) (srfi :18))

(define shared-queue (make-shared-queue))

(define thread 
  (thread-start!
    (make-thread
      (lambda ()
        ;; waits until the queue has an element
        (let ((value (shared-queue-get! shared-queue)))
          (* value value))))))

(shared-queue-put! share-queue 5)

(thread-join! thread)
</pre>
    <span class="codeblock-arrow">=&gt;</span>
    <span class="codeblock-result">25</span>
  </div>
<p /><div class="define">
    <span class="define-category">Record</span>
    <a name="<shared-queue&gt;1809">
      <span class="name" name="<shared-queue&gt;">&lt;shared-queue&gt;</span>
    </a>
  </div>
<div class="desc">Record type of shared queue.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue?1810">
    <span class="name" name="shared-queue?">shared-queue?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if given <var>obj</var> is shared queue, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="make-shared-queue1811">
    <span class="name" name="make-shared-queue">make-shared-queue</span>
  </a> <span class="args">:optional (max-length -1)</span></div>
<div class="desc">Creates a shared queue.
<p />If optional argument <var>max-length</var> is 0, then the queue can be used as
synchronised queue. If the value is positive number, then the queue can 
only have specified number of elements. If it overflows, then it waits 
until the number of elements is less than <var>max-length</var>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-empty?1812">
    <span class="name" name="shared-queue-empty?">shared-queue-empty?</span>
  </a> <span class="args">shared-queue</span></div>
<div class="desc">Returns #t if the number of elements inside of <var>shared-queue</var> is 0.
Otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-size1813">
    <span class="name" name="shared-queue-size">shared-queue-size</span>
  </a> <span class="args">shared-queue</span></div>
<div class="desc">Returns the number of elements inside of <var>shared-queue</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-max-length1814">
    <span class="name" name="shared-queue-max-length">shared-queue-max-length</span>
  </a> <span class="args">shared-queue</span></div>
<div class="desc">Returns max length of <var>shared-queue</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-overflows?1815">
    <span class="name" name="shared-queue-overflows?">shared-queue-overflows?</span>
  </a> <span class="args">shared-queue count</span></div>
<div class="desc">Returns #t if putting <var>count</var> of element into <var>shared-queue</var>
overflows. Otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-get!1816">
    <span class="name" name="shared-queue-get!">shared-queue-get!</span>
  </a>
 <span class="args">shared-queue :optional (timeout #f) (timeout-val #f)</span></div>
<div class="desc">Retrieves the first element from <var>shared-queue</var>.
<p />If the queue is empty and optional argument <var>timeout</var> is #f, then 
this procedure waits until the queue gets something.
<p />If the optional argument <var>timeout</var> is specified, then the procedure
only waits specified amount of time. <var>timeout</var> can be either integer
or time object defined in SRFI-19. If the queue didn't get any object within
the <var>timeout</var>, then <var>timeout-val</var> is returned.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-put!1817">
    <span class="name" name="shared-queue-put!">shared-queue-put!</span>
  </a>
 <span class="args">shared-queue obj :optional (timeout #f) (timeout-val #f)</span></div>
<div class="desc">Puts <var>obj</var> into <var>shared-queue</var> and returns <var>obj</var>.
<p />If the queue has <code>max-length</code> and overflows, then it wait until
it's available.
<p />If the optional argument <var>timeout</var> is specified, then the procedure
only waits specified amount of time. <var>timeout</var> can be either integer
or time object defined in SRFI-19. If the queue didn't get any object within
the <var>timeout</var>, then <var>timeout-val</var> is returned.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-remove!1818">
    <span class="name" name="shared-queue-remove!">shared-queue-remove!</span>
  </a>
 <span class="args">shared-queue obj :optional (= equal?)</span></div>
<div class="desc">Removes the given <var>obj</var> from the <var>shared-queue</var>. The procedure
returns #t if <var>obj</var> is removed, otherwise #f.
<p />Optional argument <var>=</var>, must be a comparison procedure, specifies how to
compare the element of the <var>shared-queue</var> and given <var>obj</var>. Default
value is <code>equal?</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-clear!1819">
    <span class="name" name="shared-queue-clear!">shared-queue-clear!</span>
  </a> <span class="args">shared-queue</span></div>
<div class="desc">Clears all element inside of <var>shared-queue</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-find1820">
    <span class="name" name="shared-queue-find">shared-queue-find</span>
  </a> <span class="args">shared-queue pred</span></div>
<div class="desc">Finds an elements which satisfies <var>pred</var>. This operations locks the
given <var>shared-queue</var>.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="shared-queue-locked?1821">
    <span class="name" name="shared-queue-locked?">shared-queue-locked?</span>
  </a>
 <span class="args">shared-queue :optional (wait? #f)</span></div>
<div class="desc">Returns #t if the given <var>shared-queue</var> is locked by other thread,
otherwise #f.
<p />If the optional argument <var>wait?</var> is given, then the procedure waits
until the queue is available and returns #f.
</div>
<p />
<p /></section><section class="subsubsection"><h4 class="subsubsection">
    <a class="section.anchor" name="G1822"><span class="section-number">7.8.5</span>Actor</a>
  </h4>
<p /><div class="define">
    <span class="define-category">Library</span>
    <a name="(util concurrent actor)1823">
      <span class="name" name="(util concurrent actor)">(util concurrent actor)</span>
    </a>
  </div>
<div class="desc">A sub library of <code>(util concurrent)</code>. This library provides
actor model like APIs.</div>
<p />An actor is an object which contains thread, input receiver and output sender.
This is based on the Actor model. Communication between an actor and outside of
the actor can only be done via input receiver or output sender. From here, we
call them channel. The following is a simple bank account example using actor.
<p /><pre class="codeblock">(import (rnrs) (util concurrent actor) (match))

(define (open-account initial-amount)
  (define balance initial-amount)
  (make-shared-queue-channel-actor
   (lambda (input-receiver output-sender)
     (let loop ()
       (match (input-receiver)
	 (('withdrow how-much)
	  (if (&lt; balance how-much)
	      (output-sender "invalid amount")
	      (begin
		(set! balance (- balance how-much))
		(output-sender (cons how-much balance))))
	  (loop))
	 (('deposite a)
	  (if (negative? a)
	      (output-sender "invalid amount")
	      (begin
		(set! balance (+ balance a))
		(output-sender (cons 0 balance))))
	  (loop))
	 (('close) #t)
	 (else "invalid message"))))))

(define client (open-account 1000))

(actor-send-message! client '(withdrow 100))
(actor-send-message! client '(deposite 100))
(actor-send-message! client '(close))

(actor-receive-message! client) ;; =&gt; (100 . 900)
(actor-receive-message! client) ;; =&gt; (0 . 1000)
</pre>
<p /><div class="define"><span class="define-category">Function</span><a name="actor?1824">
    <span class="name" name="actor?">actor?</span>
  </a> <span class="args">obj</span></div>
<div class="desc">Returns #t if the given <var>obj</var> is an actor, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="make-shared-queue-channel-actor1825">
    <span class="name" name="make-shared-queue-channel-actor">make-shared-queue-channel-actor</span>
  </a> <span class="args">task</span></div>
<div class="define"><span class="define-category">Function</span><a name="make-shared-priority-queue-channel-actor1826">
    <span class="name" name="make-shared-priority-queue-channel-actor">make-shared-priority-queue-channel-actor</span>
  </a>
 <span class="args">task compare</span></div>
<div class="desc">Creates actors with shared-queue or shared-priority-queue as underlying
channel implementation, respectively.
<p />If the <code>make-shared-priority-queue-channel-actor</code> is used, then the
<var>compare</var> must be a procedure which takes 2 arguments and returns the
comparison result of given 2 arguments. The value should be, -1, 0 or 1.
<p /><var>task</var> must be an procedure accepts 2 argument, <var>input-receiver</var> and
<var>output-sender</var>. The procedures' signatures are the followings:
<div class="define"><span class="define-category">Function</span><a name="input-receiver1827">
    <span class="name" name="input-receiver">input-receiver</span>
  </a> <span class="args">:optional timeout timeout-val</span></div>
<div class="define"><span class="define-category">Function</span><a name="output-sender1828">
    <span class="name" name="output-sender">output-sender</span>
  </a>
 <span class="args">messge :optional timeout timeout-val</span></div>
The <var>input-receiver</var> receives a message from outside of the actor.
<p />The <var>output-sender</var> sends a message <var>message</var> to outside of the actor.
<p />Messages can be sent to an actor via <code>actor-send-message!</code>, and be
received from an actor via <code>actor-receive-message!</code>.
<p />The optional arguments <var>timeout</var> and <var>timeout-val</var> are given, it shall
behave the same as <code>shared-queue-get!</code> or <code>shared-queue-put!</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="actor-send-message!1829">
    <span class="name" name="actor-send-message!">actor-send-message!</span>
  </a>
 <span class="args">actor message :optional timeout timeout-val</span></div>
<div class="desc">Sends the given <var>message</var> to the <var>actor</var>. The operation may block
the caller thread depending on the underlying channel implementation.
<p />If optional argument <var>timeout</var> and <var>timeout-val</var> are given, it shall
behave the same as <code>shared-queue-put!</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="actor-receive-message!1830">
    <span class="name" name="actor-receive-message!">actor-receive-message!</span>
  </a>
 <span class="args">actor :optional timeout timeout-val</span></div>
<div class="desc">Receives a message from given <var>actor</var>. The operation may block the
caller thread depending on the underlying channel implementation.
<p />If optional argument <var>timeout</var> and <var>timeout-val</var> are given, it shall
behave the same as <code>shared-queue-get!</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="actor-running?1831">
    <span class="name" name="actor-running?">actor-running?</span>
  </a> <span class="args">actor</span></div>
<div class="desc">Return #t if the given <var>actor</var> is running, otherwise #f.</div>
<p /><div class="define"><span class="define-category">Function</span><a name="actor-wait!1832">
    <span class="name" name="actor-wait!">actor-wait!</span>
  </a>
 <span class="args">actor :optional timeout timeout-val</span></div>
<div class="desc">Waits until the given <var>actor</var> is finished.
<p />The optional arguments works the same as <code>thread-join!</code>.
</div>
<p /><div class="define"><span class="define-category">Function</span><a name="actor-terminate!1833">
    <span class="name" name="actor-terminate!">actor-terminate!</span>
  </a> <span class="args">actor</span></div>
<div class="desc">Terminates the given <var>actor</var>.
<p />NOTE: This operation is not safe. It is users' responsibility to release
resource if it's needed.
</div>
<p />
</section></section>
  <div class="prev-next">
    <a class="prev" href="section77.html">(util bytevector) - Bytevector utility library</a>
    <a class="top" href="../sagittarius-online-ref.html">Top</a>
    <a class="next" href="section79.html">(crypto) - Cryptographic library</a>
  </div>
  <hr>
  <div id="document-footer">
    <div id="footer-message">This document was generated by<i>Takashi Kato</i> with Sagittarius gendoc. </div>
    <div id="footer-date">Generated date: <i>2020-08-07T14:46:26+0200</i></div>
  </div>
</html>